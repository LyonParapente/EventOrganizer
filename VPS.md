This tutorial describes how to fully configure the application on a Debian system.

(VPS stands for Virtual Private Server)

## Install required packages
```
sudo apt-get update
sudo apt-get upgrade
sudo apt install python3-pip python3-venv nginx rsync git npm
```
* git & npm are only required if you want to compile the front on the server
* rsync is for the Github deploy action

## Create dedicated user

Replace `<user>` with the name you want

```
# Create user
sudo useradd -m -N -g www-data <user> -s /bin/bash

# Create project directory
sudo mkdir /var/www/EventOrganizer
sudo chown <user>:www-data /var/www/EventOrganizer
```

## Deploy code

2 choices here:

### Via a Github action

Take a look at `.github\workflows\deploy.yml`: it does everything to compile and deploy the app once you push a commit with a tag. You simply need to declare a few secrets.

Go to Github project > Settings > Secrets and add the following variables:
* HOST: your server DNS
* PORT: ssh port
* USERNAME: username
* SSHKEY: private key, generated like so:
```
sudo -u <user> -i
ssh-keygen -t rsa -b 4096
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
cat ~/.ssh/id_rsa
```

Then push a commit with a tag and the action will be executed: https://github.com/LyonParapente/EventOrganizer/actions

## Manually compile from sources

Do this only if you don't want to use Github action.

```
sudo -u <user> -i
git clone https://github.com/LyonParapente/EventOrganizer
```

Compile the front:
```
cd EventOrganizer/front
npm install --dev
gulp  # this compiles front
```
This will compile the front and put what's needed inside /back/static/.

## Install python requirements
Ok now you have the release files (the /back/ folder + what was generated by front).  
We need to configure python:
```
cd /var/www/EventOrganizer # add "/back" if you compile from sources
python3 -m venv env
source env/bin/activate
pip install wheel  # to ensure that our packages will install even if they are missing wheel archives
pip install -r requirements.txt
pip install gunicorn
```

## Setup application
```
cp secrets.sample.py secrets.py
nano secrets.py  # make required changes
```

## Manual tests to run application
```
#python3 app_flask.py
#gunicorn --bind 0.0.0.0:8000 app_flask:app
#Must be root port ports<1024
#sudo gunicorn3 --bind 0.0.0.0:80 -w 4 app_flask:app -u <user> -g <group> --pythonpath /var/www/EventOrganizer/back/env/lib/python3.7/site-packages
```

We're now done with our virtual environment, so we can deactivate it:  
`deactivate`

## Create a systemd service
(You can also use supervisor rather than systemd)

`sudo nano /etc/systemd/system/eventorganizer.service`

Fill this in, don't forget to replace `<user>`:
```
[Unit]
Description=EventOrganizer Gunicorn instance
After=network.target

[Service]
User=<user>
Group=www-data
WorkingDirectory=/var/www/EventOrganizer
Environment="PATH=/var/www/EventOrganizer/env/bin"
ExecStart=/var/www/EventOrganizer/env/bin/gunicorn --workers 4 --bind unix:eventorganizer.sock -m 007 app_flask:app
Restart=always

[Install]
WantedBy=multi-user.target
```
Then enable, start and check the service:
```
sudo systemctl enable eventorganizer
sudo systemctl start eventorganizer
sudo systemctl status eventorganizer
```

## Configuring Nginx to Proxy Requests

### HTTP listener
`sudo nano /etc/nginx/sites-available/eventorganizer`

Copy this content:
```
server {
    listen 80;
    server_name <your_domain>;

    location / {
        include proxy_params;
        proxy_pass http://unix:/var/www/EventOrganizer/eventorganizer.sock;
    }
}
```
`<your_domain>` = calendrier.lyonparapente.fr in our case  
Note: we have a DNS entry type CNAME to link this to the hosting server  

Enable the configuration:  
`sudo ln -s /etc/nginx/sites-available/eventorganizer /etc/nginx/sites-enabled`

Test for syntax errors:  
`sudo nginx -t`

Restart nginx:  
`sudo systemctl restart nginx`


### Activate HTTPS
```
sudo apt install python3-certbot-nginx
sudo certbot --nginx -d <your_domain>
```

Activate HTTP2 by editing:  
`sudo nano /etc/nginx/sites-enabled/eventorganizer`  
Add "http2" in the following line:  
`listen 443 ssl http2; # managed by Certbot`

## Secure your server
```
sudo apt install fail2ban
nano /etc/ssh/sshd_config  # Set Port to something else than 22
/etc/init.d/ssh restart
```
### Hardening nginx
`sudo nano /etc/nginx/sites-enabled/eventorganizer`
Add this at the top of the file:

```
# don't send the nginx version number in error pages and Server header
server_tokens off;

# config to don't allow the browser to render the page inside an frame or iframe
add_header X-Frame-Options SAMEORIGIN;
```
Comment the following line:  
`include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot`  
and add this in the section, following https://gist.github.com/plentz/6737338:

```
    # enables server-side protection from BEAST attacks
    # http://blog.ivanristic.com/2013/09/is-beast-still-a-threat.html
    ssl_prefer_server_ciphers on;
    # disable SSLv3(enabled by default since nginx 0.8.19) since it's less secure then TLS http://en.wikipedia.org/wiki/Secure_Sockets_Layer#SSL_3.0
    ssl_protocols TLSv1.2 TLSv1.3;
    # ciphers chosen for forward secrecy and compatibility
    # http://blog.ivanristic.com/2013/08/configuring-apache-nginx-and-openssl-for-forward-secrecy.html
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';

    # enable ocsp stapling (mechanism by which a site can convey certificate revocation information to visitors in a privacy-preserving, scalable manner)
    # http://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox/
    resolver 8.8.8.8 8.8.4.4;
    ssl_stapling on;
    ssl_stapling_verify on;
```
Test: `sudo nginx -t`  
Apply changes: `sudo systemctl restart nginx`  


## Useful
A few helpful commands:
```
source /var/www/EventOrganizer/back/env/bin/activate
less /var/log/nginx/error.log
less /var/log/nginx/access.log
journalctl -u nginx
journalctl -u eventorganizer
echo "alias o='ls -AlFh --time-style=long-iso --color=auto'" >~/.bash_aliases
```

## Links
https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-20-04
